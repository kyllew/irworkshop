{% extends "base.html" %}

{% block title %}Dashboard - AWS Threat Catalog{% endblock %}

{% block content %}
<!-- Disclaimer Banner -->
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Educational Tool:</strong> This is not an official AWS source and is for educational purposes only.
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i>
            AWS Threat Catalog Dashboard
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_techniques }}</h4>
                        <p class="card-text">Total Techniques</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.tactic_counts|length }}</h4>
                        <p class="card-text">MITRE Tactics</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-bullseye fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.severity_counts.get('CRITICAL', 0) + stats.severity_counts.get('HIGH', 0) }}</h4>
                        <p class="card-text">High Risk Techniques</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="analysis-count">0</h4>
                        <p class="card-text">Analyses Today</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i>
                    Techniques by Tactic
                </h5>
            </div>
            <div class="card-body">
                <canvas id="tacticChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Severity Distribution Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i>
                    Severity Distribution
                    <small class="text-muted">(Click on bars to see details)</small>
                </h5>
            </div>
            <div class="card-body">
                <canvas id="severityChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Analysis Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt"></i>
                    Quick Analysis
                </h5>
            </div>
            <div class="card-body">
                <form id="quickAnalysisForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="position-relative">
                                <input type="text" class="form-control" id="quickApiCall" 
                                       placeholder="Enter AWS API call (e.g., iam:CreateUser)" 
                                       autocomplete="off">
                                <div id="autocompleteDropdown" class="autocomplete-dropdown" style="display: none;"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> Analyze
                            </button>
                        </div>
                    </div>
                </form>
                
                <div id="quickAnalysisResult" class="mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity / System Status -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock"></i>
                    System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Threat Database</span>
                    <span class="badge bg-success">Online</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>API Endpoints</span>
                    <span class="badge bg-success">Healthy</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Last Database Update</span>
                    <span class="text-muted" id="lastUpdate">Loading...</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Response Time</span>
                    <span class="text-success" id="responseTime">< 100ms</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-link"></i>
                    Quick Links
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/analyze" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> Full Analysis
                    </a>
                    <a href="/database" class="btn btn-outline-info">
                        <i class="fas fa-database"></i> Browse Database
                    </a>
                    <a href="https://attack.mitre.org/" target="_blank" class="btn btn-outline-secondary">
                        <i class="fas fa-external-link-alt"></i> MITRE ATT&CK
                    </a>
                    <a href="https://aws-samples.github.io/threat-technique-catalog-for-aws/" target="_blank" class="btn btn-outline-secondary">
                        <i class="fas fa-external-link-alt"></i> AWS Threat Catalog
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Severity Details Modal -->
<div class="modal fade" id="severityModal" tabindex="-1" aria-labelledby="severityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="severityModalLabel">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="modalSeverityName"></span> Severity Techniques
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Total Techniques:</strong> <span id="modalSeverityCount"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Risk Level:</strong> <span id="modalSeverityDescription"></span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Technique ID</th>
                                <th>Name</th>
                                <th>Tactic</th>
                                <th>API Calls</th>
                            </tr>
                        </thead>
                        <tbody id="modalSeverityTechniquesList">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportSeverityData()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tactic Details Modal -->
<div class="modal fade" id="tacticModal" tabindex="-1" aria-labelledby="tacticModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tacticModalLabel">
                    <i class="fas fa-bullseye"></i>
                    <span id="modalTacticName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Total Techniques:</strong> <span id="modalTacticCount"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Description:</strong> <span id="modalTacticDescription"></span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Technique ID</th>
                                <th>Name</th>
                                <th>Severity</th>
                                <th>API Calls</th>
                            </tr>
                        </thead>
                        <tbody id="modalTechniquesList">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportTacticData()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        // Tactic distribution chart
        const tacticData = {{ stats.tactic_counts | tojson }};
        const tacticCtx = document.getElementById('tacticChart').getContext('2d');
        window.tacticChart = new Chart(tacticCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(tacticData),
                datasets: [{
                    data: Object.values(tacticData),
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB', 
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                },
                onClick: function(event, elements) {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const tacticName = Object.keys(tacticData)[index];
                        showTacticDetails(tacticName);
                    }
                }
            }
        });
        
        // Severity distribution chart
        const severityData = {{ stats.severity_counts | tojson }};
        const severityCtx = document.getElementById('severityChart').getContext('2d');
        window.severityChart = new Chart(severityCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(severityData),
                datasets: [{
                    label: 'Count',
                    data: Object.values(severityData),
                    backgroundColor: [
                        '#dc3545', // CRITICAL
                        '#fd7e14', // HIGH
                        '#ffc107', // MEDIUM
                        '#28a745'  // LOW
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                return 'Click to see details';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                onClick: function(event, elements) {
                    console.log('Chart clicked!', event, elements);
                    if (elements && elements.length > 0) {
                        const index = elements[0].index;
                        const severityLevel = Object.keys(severityData)[index];
                        console.log('Clicked severity level:', severityLevel);
                        showSeverityDetails(severityLevel);
                    } else {
                        console.log('No elements found in click');
                    }
                },
                onHover: function(event, elements) {
                    const canvas = event.chart.canvas;
                    canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                }
            }
        });
        
        // Load system status
        loadSystemStatus();
        
        // Set up quick analysis form
        setupQuickAnalysis();
    });
    
    function loadSystemStatus() {
        fetch('/api/database/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('lastUpdate').textContent = 
                    new Date(data.last_updated).toLocaleString();
            })
            .catch(error => {
                document.getElementById('lastUpdate').textContent = 'Error loading';
            });
    }
    
    function setupQuickAnalysis() {
        const apiCallInput = document.getElementById('quickApiCall');
        const dropdown = document.getElementById('autocompleteDropdown');
        let currentSuggestions = [];
        let selectedIndex = -1;
        let debounceTimer = null;
        
        // Setup autocomplete functionality
        apiCallInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            
            // Clear previous timer
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
            
            // Debounce the API call
            debounceTimer = setTimeout(() => {
                if (query.length >= 2) {
                    fetchAutocompleteSuggestions(query);
                } else {
                    hideDropdown();
                }
            }, 300);
        });
        
        // Handle keyboard navigation
        apiCallInput.addEventListener('keydown', function(e) {
            if (dropdown.style.display === 'none') return;
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                    updateSelection();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection();
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
                        selectSuggestion(currentSuggestions[selectedIndex].api_call);
                    }
                    break;
                case 'Escape':
                    hideDropdown();
                    break;
            }
        });
        
        // Hide dropdown when clicking outside (with delay to allow item clicks)
        document.addEventListener('click', function(e) {
            // Don't hide immediately if clicking on dropdown items
            if (dropdown.contains(e.target)) {
                return;
            }
            
            if (!apiCallInput.contains(e.target)) {
                // Small delay to allow click events to process
                setTimeout(() => {
                    hideDropdown();
                }, 100);
            }
        });
        
        function fetchAutocompleteSuggestions(query) {
            fetch(`/api/database/autocomplete?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    currentSuggestions = data.suggestions || [];
                    displaySuggestions(currentSuggestions);
                })
                .catch(error => {
                    console.error('Error fetching autocomplete suggestions:', error);
                    hideDropdown();
                });
        }
        
        function displaySuggestions(suggestions) {
            if (suggestions.length === 0) {
                hideDropdown();
                return;
            }
            
            dropdown.innerHTML = suggestions.map((suggestion, index) => `
                <div class="autocomplete-item" data-index="${index}" data-api-call="${suggestion.api_call}">
                    <span class="autocomplete-api-call">${suggestion.api_call}</span>
                    <span class="autocomplete-service">${suggestion.service}</span>
                </div>
            `).join('');
            
            // Add click event listeners to each item
            dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const apiCall = this.getAttribute('data-api-call');
                    selectSuggestion(apiCall);
                });
            });
            
            selectedIndex = -1;
            dropdown.style.display = 'block';
        }
        
        function updateSelection() {
            const items = dropdown.querySelectorAll('.autocomplete-item');
            items.forEach((item, index) => {
                item.classList.toggle('active', index === selectedIndex);
            });
        }
        
        function selectSuggestion(apiCall) {
            if (apiCall) {
                apiCallInput.value = apiCall;
                hideDropdown();
                // Small delay to ensure dropdown is hidden before focusing
                setTimeout(() => {
                    apiCallInput.focus();
                }, 50);
            }
        }
        
        function hideDropdown() {
            dropdown.style.display = 'none';
            selectedIndex = -1;
            currentSuggestions = [];
        }
        
        // Original form submission handler
        document.getElementById('quickAnalysisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const apiCall = document.getElementById('quickApiCall').value.trim();
            if (!apiCall) return;
            
            const resultDiv = document.getElementById('quickAnalysisResult');
            resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Analyzing...</div>';
            resultDiv.style.display = 'block';
            
            // First, get exact match
            fetch('/api/analyze/single', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_call: apiCall })
            })
            .then(response => response.json())
            .then(data => {
                let resultHtml = '';
                
                // Show exact match if found
                if (data.technique_found) {
                    const technique = data.technique_info;
                    resultHtml += `
                        <div class="card border-success mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-bullseye"></i> <strong>Exact Match Found</strong></h6>
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">${technique.technique_name} <small class="text-muted">(${technique.technique_id})</small></h5>
                                <p class="card-text">${technique.description}</p>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Tactic:</strong> <span class="badge bg-secondary">${technique.tactic}</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Severity:</strong> <span class="badge bg-${getSeverityBadgeClass(technique.severity)}">${technique.severity}</span>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <strong>AWS Services:</strong>
                                        <div class="mt-1">
                                            ${technique.aws_services.map(service => `<span class="badge bg-info me-1">${service}</span>`).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <strong>API Calls:</strong>
                                        <div class="mt-1">
                                            ${technique.api_calls.map(api => `<code class="me-2">${api}</code>`).join('')}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <strong>Detection Methods:</strong>
                                        <ul class="mt-2">
                                            ${technique.detection_methods.map(method => `<li>${method}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <strong>Mitigation:</strong>
                                        <p class="mt-2 alert alert-warning">${technique.mitigation}</p>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-12">
                                        <strong>Resources:</strong>
                                        <div class="mt-2">
                                            ${technique.playbook_url ? `
                                                <a href="${technique.playbook_url}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                                    <i class="fas fa-book"></i> View Playbook
                                                </a>
                                            ` : ''}
                                            <a href="${getAwsApiDocUrl(apiCall)}" target="_blank" class="btn btn-sm btn-outline-info">
                                                <i class="fab fa-aws"></i> AWS API Documentation
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Now search for related techniques
                return fetch(`/api/database/search?q=${encodeURIComponent(apiCall)}`)
                    .then(response => response.json())
                    .then(searchData => {
                        if (searchData.results && searchData.results.length > 0) {
                            // Filter out the exact match if it exists
                            const relatedTechniques = searchData.results.filter(result => 
                                !data.technique_found || result.api_call !== apiCall
                            );
                            
                            if (relatedTechniques.length > 0) {
                                resultHtml += `
                                    <div class="card border-info mb-3">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0"><i class="fas fa-search"></i> <strong>Related Attack Techniques</strong></h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="mb-3">Found ${relatedTechniques.length} related techniques in the threat catalog:</p>
                                            <div class="accordion" id="relatedTechniquesAccordion">
                                                ${relatedTechniques.slice(0, 5).map((technique, index) => `
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header" id="heading${index}">
                                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                                                                <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                                                    <div>
                                                                        <strong>${technique.technique_name}</strong> 
                                                                        <small class="text-muted">(${technique.technique_id})</small>
                                                                    </div>
                                                                    <div>
                                                                        <span class="badge bg-secondary me-2">${technique.tactic}</span>
                                                                        <span class="badge bg-${getSeverityBadgeClass(technique.severity)}">${technique.severity}</span>
                                                                    </div>
                                                                </div>
                                                            </button>
                                                        </h2>
                                                        <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}" data-bs-parent="#relatedTechniquesAccordion">
                                                            <div class="accordion-body">
                                                                <p><strong>Description:</strong> ${technique.description}</p>
                                                                <p><strong>API Call:</strong> <code>${technique.api_call}</code></p>
                                                                <p><strong>AWS Services:</strong> ${technique.aws_services ? technique.aws_services.join(', ') : 'N/A'}</p>
                                                                <div class="mt-3">
                                                                    <button class="btn btn-sm btn-outline-primary" onclick="showTechniqueDetails('${technique.api_call}')">
                                                                        <i class="fas fa-info-circle"></i> View Full Details
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ${relatedTechniques.length > 5 ? `<p class="text-muted small mt-3">Showing first 5 of ${relatedTechniques.length} related techniques. <a href="/database?q=${encodeURIComponent(apiCall)}">View all results</a></p>` : ''}
                                        </div>
                                    </div>
                                `;
                            }
                        }
                        
                        if (!data.technique_found && (!searchData.results || searchData.results.length === 0)) {
                            resultHtml += `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    No threat intelligence found for <code>${apiCall}</code>
                                    <br><small class="text-muted">Try searching for related terms or check the database for similar API calls.</small>
                                </div>
                            `;
                        }
                        
                        resultDiv.innerHTML = resultHtml;
                    });
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times"></i>
                        Error analyzing API call: ${error.message}
                    </div>
                `;
            });
        });
    }
    
    function getSeverityBadgeClass(severity) {
        const severityMap = {
            'CRITICAL': 'danger',
            'HIGH': 'warning',
            'MEDIUM': 'info',
            'LOW': 'success'
        };
        return severityMap[severity] || 'secondary';
    }
    
    // Generate AWS API documentation URL
    function getAwsApiDocUrl(apiCall) {
        if (!apiCall || !apiCall.includes(':')) return null;
        
        const [service, action] = apiCall.split(':');
        const serviceLower = service.toLowerCase();
        
        // AWS documentation URL patterns for different services
        const serviceUrlMap = {
            's3': `https://docs.aws.amazon.com/AmazonS3/latest/API/API_${action}.html`,
            'iam': `https://docs.aws.amazon.com/IAM/latest/APIReference/API_${action}.html`,
            'ec2': `https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_${action}.html`,
            'lambda': `https://docs.aws.amazon.com/lambda/latest/api/API_${action}.html`,
            'cloudtrail': `https://docs.aws.amazon.com/awscloudtrail/latest/APIReference/API_${action}.html`,
            'cloudformation': `https://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/API_${action}.html`,
            'rds': `https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_${action}.html`,
            'dynamodb': `https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_${action}.html`,
            'sns': `https://docs.aws.amazon.com/sns/latest/api/API_${action}.html`,
            'sqs': `https://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/API_${action}.html`,
            'kms': `https://docs.aws.amazon.com/kms/latest/APIReference/API_${action}.html`,
            'sts': `https://docs.aws.amazon.com/STS/latest/APIReference/API_${action}.html`,
            'secretsmanager': `https://docs.aws.amazon.com/secretsmanager/latest/apireference/API_${action}.html`,
            'ssm': `https://docs.aws.amazon.com/systems-manager/latest/APIReference/API_${action}.html`,
            'route53': `https://docs.aws.amazon.com/Route53/latest/APIReference/API_${action}.html`,
            'cloudwatch': `https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_${action}.html`,
            'logs': `https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_${action}.html`,
            'apigateway': `https://docs.aws.amazon.com/apigateway/latest/api/API_${action}.html`,
            'elasticloadbalancing': `https://docs.aws.amazon.com/elasticloadbalancing/latest/APIReference/API_${action}.html`,
            'autoscaling': `https://docs.aws.amazon.com/autoscaling/ec2/APIReference/API_${action}.html`,
            'ecs': `https://docs.aws.amazon.com/AmazonECS/latest/APIReference/API_${action}.html`,
            'ecr': `https://docs.aws.amazon.com/AmazonECR/latest/APIReference/API_${action}.html`
        };
        
        return serviceUrlMap[serviceLower] || `https://docs.aws.amazon.com/search/doc-search.html?searchPath=documentation&searchQuery=${encodeURIComponent(apiCall)}`;
    }
    
    // Show full technique details in a modal
    function showTechniqueDetails(apiCall) {
        // Fetch detailed technique information
        fetch('/api/analyze/single', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ api_call: apiCall })
        })
        .then(response => response.json())
        .then(data => {
            if (data.technique_found) {
                const technique = data.technique_info;
                
                // Create modal content
                const modalContent = `
                    <div class="modal fade" id="techniqueDetailModal" tabindex="-1" aria-labelledby="techniqueDetailModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="techniqueDetailModalLabel">
                                        <i class="fas fa-shield-alt"></i>
                                        ${technique.technique_name} (${technique.technique_id})
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <strong>Tactic:</strong> <span class="badge bg-secondary">${technique.tactic}</span>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Severity:</strong> <span class="badge bg-${getSeverityBadgeClass(technique.severity)}">${technique.severity}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>Description:</strong>
                                        <p class="mt-2">${technique.description}</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>AWS Services:</strong>
                                        <div class="mt-2">
                                            ${technique.aws_services.map(service => `<span class="badge bg-info me-1">${service}</span>`).join('')}
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>API Calls:</strong>
                                        <div class="mt-2">
                                            ${technique.api_calls.map(api => `<code class="me-2">${api}</code>`).join('')}
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>Detection Methods:</strong>
                                        <ul class="mt-2">
                                            ${technique.detection_methods.map(method => `<li>${method}</li>`).join('')}
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>Mitigation:</strong>
                                        <div class="alert alert-warning mt-2">${technique.mitigation}</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <strong>Resources:</strong>
                                        <div class="mt-2">
                                            ${technique.playbook_url ? `
                                                <a href="${technique.playbook_url}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                                    <i class="fas fa-book"></i> View Playbook
                                                </a>
                                            ` : ''}
                                            <a href="${getAwsApiDocUrl(apiCall)}" target="_blank" class="btn btn-sm btn-outline-info">
                                                <i class="fab fa-aws"></i> AWS API Documentation
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if any
                const existingModal = document.getElementById('techniqueDetailModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('techniqueDetailModal'));
                modal.show();
                
                // Clean up modal after it's hidden
                document.getElementById('techniqueDetailModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
            }
        })
        .catch(error => {
            console.error('Error fetching technique details:', error);
            alert('Error loading technique details. Please try again.');
        });
    }
    

    
    // Show severity details modal
    function showSeverityDetails(severityLevel) {
        console.log('showSeverityDetails called with:', severityLevel);
        
        // Set modal title
        document.getElementById('modalSeverityName').textContent = severityLevel;
        
        // Get the severity data from the global variable
        const currentSeverityData = {{ stats.severity_counts | tojson }};
        document.getElementById('modalSeverityCount').textContent = currentSeverityData[severityLevel] || 0;
        
        // Get severity description
        const severityDescriptions = {
            'CRITICAL': 'Immediate threat requiring urgent attention',
            'HIGH': 'Significant risk requiring prompt action',
            'MEDIUM': 'Moderate risk requiring monitoring',
            'LOW': 'Minor risk for awareness'
        };
        
        document.getElementById('modalSeverityDescription').textContent = 
            severityDescriptions[severityLevel] || 'Risk level for threat analysis.';
        
        // Load techniques for this severity level
        loadSeverityTechniques(severityLevel);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('severityModal'));
        modal.show();
    }
    
    // Load techniques for a specific severity level
    function loadSeverityTechniques(severityLevel) {
        console.log('Loading techniques for severity:', severityLevel);
        const tbody = document.getElementById('modalSeverityTechniquesList');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        
        // Fetch techniques from the new severity endpoint
        fetch(`/api/database/severity/${encodeURIComponent(severityLevel)}`)
            .then(response => {
                console.log('API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('API response data:', data);
                if (data.techniques && data.techniques.length > 0) {
                    tbody.innerHTML = data.techniques.map(technique => `
                        <tr>
                            <td><code>${technique.technique_id}</code></td>
                            <td><strong>${technique.technique_name}</strong></td>
                            <td><span class="badge bg-secondary">${technique.tactic}</span></td>
                            <td><code>${technique.api_call}</code></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No techniques found for this severity level.</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading techniques:', error);
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading techniques.</td></tr>';
            });
    }
    
    // Export severity data
    function exportSeverityData() {
        const severityLevel = document.getElementById('modalSeverityName').textContent;
        const table = document.getElementById('modalSeverityTechniquesList');
        const rows = table.querySelectorAll('tr');
        
        let csv = 'Technique ID,Name,Tactic,API Call\n';
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 4) {
                const techniqueId = cells[0].textContent.replace(/`/g, '');
                const name = cells[1].textContent.replace(/\*/g, '');
                const tactic = cells[2].textContent;
                const apiCall = cells[3].textContent.replace(/`/g, '');
                
                csv += `"${techniqueId}","${name}","${tactic}","${apiCall}"\n`;
            }
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${severityLevel.toLowerCase()}_severity_techniques.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // Show tactic details modal
    function showTacticDetails(tacticName) {
        // Set modal title
        document.getElementById('modalTacticName').textContent = tacticName;
        document.getElementById('modalTacticCount').textContent = {{ stats.tactic_counts | tojson }}[tacticName] || 0;
        
        // Get tactic description
        const tacticDescriptions = {
            'Initial Access': 'The adversary is trying to get into your network.',
            'Execution': 'The adversary is trying to run malicious code.',
            'Persistence': 'The adversary is trying to maintain their foothold.',
            'Privilege Escalation': 'The adversary is trying to gain higher-level permissions.',
            'Defense Evasion': 'The adversary is trying to avoid being detected.',
            'Credential Access': 'The adversary is trying to steal account names and passwords.',
            'Discovery': 'The adversary is trying to figure out your environment.',
            'Lateral Movement': 'The adversary is trying to move through your environment.',
            'Collection': 'The adversary is trying to gather data of interest to their goal.',
            'Command and Control': 'The adversary is trying to communicate with compromised systems.',
            'Exfiltration': 'The adversary is trying to steal data.',
            'Impact': 'The adversary is trying to manipulate, interrupt, or destroy your systems and data.'
        };
        
        document.getElementById('modalTacticDescription').textContent = 
            tacticDescriptions[tacticName] || 'MITRE ATT&CK tactic for threat analysis.';
        
        // Load techniques for this tactic
        loadTacticTechniques(tacticName);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('tacticModal'));
        modal.show();
    }
    
    // Load techniques for a specific tactic
    function loadTacticTechniques(tacticName) {
        const tbody = document.getElementById('modalTechniquesList');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        
        // Fetch techniques from the database
        fetch(`/api/database/search?q=${encodeURIComponent(tacticName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    const techniques = data.results.filter(result => 
                        result.tactic.toLowerCase() === tacticName.toLowerCase()
                    );
                    
                    tbody.innerHTML = techniques.map(technique => `
                        <tr>
                            <td><code>${technique.technique_id}</code></td>
                            <td><strong>${technique.technique_name}</strong></td>
                            <td><span class="badge bg-${getSeverityBadgeClass(technique.severity)}">${technique.severity}</span></td>
                            <td><code>${technique.api_call}</code></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No techniques found for this tactic.</td></tr>';
                }
            })
            .catch(error => {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading techniques.</td></tr>';
                console.error('Error loading techniques:', error);
            });
    }
    
    // Export tactic data
    function exportTacticData() {
        const tacticName = document.getElementById('modalTacticName').textContent;
        const table = document.getElementById('modalTechniquesList');
        const rows = table.querySelectorAll('tr');
        
        let csv = 'Technique ID,Name,Severity,API Call\n';
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 4) {
                const techniqueId = cells[0].textContent.replace(/`/g, '');
                const name = cells[1].textContent.replace(/\*/g, '');
                const severity = cells[2].textContent;
                const apiCall = cells[3].textContent.replace(/`/g, '');
                
                csv += `"${techniqueId}","${name}","${severity}","${apiCall}"\n`;
            }
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${tacticName.replace(/\s+/g, '_')}_techniques.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
</script>
{% endblock %}