{% extends "base.html" %}

{% block title %}Dashboard - AWS Threat Intelligence Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i>
            Threat Intelligence Dashboard
        </h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_techniques }}</h4>
                        <p class="card-text">Total Techniques</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-database fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.tactic_counts|length }}</h4>
                        <p class="card-text">MITRE Tactics</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-bullseye fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.severity_counts.get('CRITICAL', 0) + stats.severity_counts.get('HIGH', 0) }}</h4>
                        <p class="card-text">High Risk Techniques</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="analysis-count">0</h4>
                        <p class="card-text">Analyses Today</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie"></i>
                    Techniques by Tactic
                </h5>
            </div>
            <div class="card-body">
                <canvas id="tacticChart" width="400" height="400"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Severity Distribution Row -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar"></i>
                    Severity Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="severityChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Quick Analysis Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt"></i>
                    Quick Analysis
                </h5>
            </div>
            <div class="card-body">
                <form id="quickAnalysisForm">
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="quickApiCall" 
                                   placeholder="Enter AWS API call (e.g., iam:CreateUser)" 
                                   autocomplete="off">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search"></i> Analyze
                            </button>
                        </div>
                    </div>
                </form>
                
                <div id="quickAnalysisResult" class="mt-3" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity / System Status -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clock"></i>
                    System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Threat Database</span>
                    <span class="badge bg-success">Online</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>API Endpoints</span>
                    <span class="badge bg-success">Healthy</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Last Database Update</span>
                    <span class="text-muted" id="lastUpdate">Loading...</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Response Time</span>
                    <span class="text-success" id="responseTime">< 100ms</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-link"></i>
                    Quick Links
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/analyze" class="btn btn-outline-primary">
                        <i class="fas fa-search"></i> Full Analysis
                    </a>
                    <a href="/database" class="btn btn-outline-info">
                        <i class="fas fa-database"></i> Browse Database
                    </a>
                    <a href="https://attack.mitre.org/" target="_blank" class="btn btn-outline-secondary">
                        <i class="fas fa-external-link-alt"></i> MITRE ATT&CK
                    </a>
                    <a href="https://aws-samples.github.io/threat-technique-catalog-for-aws/" target="_blank" class="btn btn-outline-secondary">
                        <i class="fas fa-external-link-alt"></i> AWS Threat Catalog
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tactic Details Modal -->
<div class="modal fade" id="tacticModal" tabindex="-1" aria-labelledby="tacticModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tacticModalLabel">
                    <i class="fas fa-bullseye"></i>
                    <span id="modalTacticName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Total Techniques:</strong> <span id="modalTacticCount"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Description:</strong> <span id="modalTacticDescription"></span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Technique ID</th>
                                <th>Name</th>
                                <th>Severity</th>
                                <th>API Calls</th>
                            </tr>
                        </thead>
                        <tbody id="modalTechniquesList">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportTacticData()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        // Tactic distribution chart
        const tacticData = {{ stats.tactic_counts | tojson }};
        const tacticCtx = document.getElementById('tacticChart').getContext('2d');
        window.tacticChart = new Chart(tacticCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(tacticData),
                datasets: [{
                    data: Object.values(tacticData),
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB', 
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                },
                onClick: function(event, elements) {
                    if (elements.length > 0) {
                        const index = elements[0].index;
                        const tacticName = Object.keys(tacticData)[index];
                        showTacticDetails(tacticName);
                    }
                }
            }
        });
        
        // Severity distribution chart
        const severityData = {{ stats.severity_counts | tojson }};
        const severityCtx = document.getElementById('severityChart').getContext('2d');
        new Chart(severityCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(severityData),
                datasets: [{
                    label: 'Count',
                    data: Object.values(severityData),
                    backgroundColor: [
                        '#dc3545', // CRITICAL
                        '#fd7e14', // HIGH
                        '#ffc107', // MEDIUM
                        '#28a745'  // LOW
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Load system status
        loadSystemStatus();
        
        // Set up quick analysis form
        setupQuickAnalysis();
    });
    
    function loadSystemStatus() {
        fetch('/api/database/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('lastUpdate').textContent = 
                    new Date(data.last_updated).toLocaleString();
            })
            .catch(error => {
                document.getElementById('lastUpdate').textContent = 'Error loading';
            });
    }
    
    function setupQuickAnalysis() {
        document.getElementById('quickAnalysisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const apiCall = document.getElementById('quickApiCall').value.trim();
            if (!apiCall) return;
            
            const resultDiv = document.getElementById('quickAnalysisResult');
            resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Analyzing...</div>';
            resultDiv.style.display = 'block';
            
            // First, get exact match
            fetch('/api/analyze/single', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_call: apiCall })
            })
            .then(response => response.json())
            .then(data => {
                let resultHtml = '';
                
                // Show exact match if found
                if (data.technique_found) {
                    const technique = data.technique_info;
                    resultHtml += `
                        <div class="alert alert-success">
                            <h6><i class="fas fa-exact-match"></i> <strong>Exact Match Found</strong></h6>
                            <h6><strong>${technique.technique_name}</strong> (${technique.technique_id})</h6>
                            <p class="mb-2">${technique.description}</p>
                            <div class="d-flex gap-2">
                                <span class="badge bg-secondary">${technique.tactic}</span>
                                <span class="badge bg-${getSeverityBadgeClass(technique.severity)}">${technique.severity}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Now search for related techniques
                return fetch(`/api/database/search?q=${encodeURIComponent(apiCall)}`)
                    .then(response => response.json())
                    .then(searchData => {
                        if (searchData.results && searchData.results.length > 0) {
                            // Filter out the exact match if it exists
                            const relatedTechniques = searchData.results.filter(result => 
                                !data.technique_found || result.api_call !== apiCall
                            );
                            
                            if (relatedTechniques.length > 0) {
                                resultHtml += `
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-search"></i> <strong>Related Attack Techniques</strong></h6>
                                        <p class="mb-2">Found ${relatedTechniques.length} related techniques in the threat catalog:</p>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Technique ID</th>
                                                        <th>Name</th>
                                                        <th>Tactic</th>
                                                        <th>Severity</th>
                                                        <th>API Call</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${relatedTechniques.slice(0, 10).map(technique => `
                                                        <tr>
                                                            <td><code>${technique.technique_id}</code></td>
                                                            <td><strong>${technique.technique_name}</strong></td>
                                                            <td><span class="badge bg-secondary">${technique.tactic}</span></td>
                                                            <td><span class="badge bg-${getSeverityBadgeClass(technique.severity)}">${technique.severity}</span></td>
                                                            <td><code>${technique.api_call}</code></td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                        ${relatedTechniques.length > 10 ? `<p class="text-muted small">Showing first 10 of ${relatedTechniques.length} related techniques.</p>` : ''}
                                    </div>
                                `;
                            }
                        }
                        
                        if (!data.technique_found && (!searchData.results || searchData.results.length === 0)) {
                            resultHtml += `
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    No threat intelligence found for <code>${apiCall}</code>
                                    <br><small class="text-muted">Try searching for related terms or check the database for similar API calls.</small>
                                </div>
                            `;
                        }
                        
                        resultDiv.innerHTML = resultHtml;
                    });
            })
            .catch(error => {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times"></i>
                        Error analyzing API call: ${error.message}
                    </div>
                `;
            });
        });
    }
    
    function getSeverityBadgeClass(severity) {
        const severityMap = {
            'CRITICAL': 'danger',
            'HIGH': 'warning',
            'MEDIUM': 'info',
            'LOW': 'success'
        };
        return severityMap[severity] || 'secondary';
    }
    

    
    // Show tactic details modal
    function showTacticDetails(tacticName) {
        // Set modal title
        document.getElementById('modalTacticName').textContent = tacticName;
        document.getElementById('modalTacticCount').textContent = {{ stats.tactic_counts | tojson }}[tacticName] || 0;
        
        // Get tactic description
        const tacticDescriptions = {
            'Initial Access': 'The adversary is trying to get into your network.',
            'Execution': 'The adversary is trying to run malicious code.',
            'Persistence': 'The adversary is trying to maintain their foothold.',
            'Privilege Escalation': 'The adversary is trying to gain higher-level permissions.',
            'Defense Evasion': 'The adversary is trying to avoid being detected.',
            'Credential Access': 'The adversary is trying to steal account names and passwords.',
            'Discovery': 'The adversary is trying to figure out your environment.',
            'Lateral Movement': 'The adversary is trying to move through your environment.',
            'Collection': 'The adversary is trying to gather data of interest to their goal.',
            'Command and Control': 'The adversary is trying to communicate with compromised systems.',
            'Exfiltration': 'The adversary is trying to steal data.',
            'Impact': 'The adversary is trying to manipulate, interrupt, or destroy your systems and data.'
        };
        
        document.getElementById('modalTacticDescription').textContent = 
            tacticDescriptions[tacticName] || 'MITRE ATT&CK tactic for threat analysis.';
        
        // Load techniques for this tactic
        loadTacticTechniques(tacticName);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('tacticModal'));
        modal.show();
    }
    
    // Load techniques for a specific tactic
    function loadTacticTechniques(tacticName) {
        const tbody = document.getElementById('modalTechniquesList');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
        
        // Fetch techniques from the database
        fetch(`/api/database/search?q=${encodeURIComponent(tacticName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    const techniques = data.results.filter(result => 
                        result.tactic.toLowerCase() === tacticName.toLowerCase()
                    );
                    
                    tbody.innerHTML = techniques.map(technique => `
                        <tr>
                            <td><code>${technique.technique_id}</code></td>
                            <td><strong>${technique.technique_name}</strong></td>
                            <td><span class="badge bg-${getSeverityBadgeClass(technique.severity)}">${technique.severity}</span></td>
                            <td><code>${technique.api_call}</code></td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No techniques found for this tactic.</td></tr>';
                }
            })
            .catch(error => {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading techniques.</td></tr>';
                console.error('Error loading techniques:', error);
            });
    }
    
    // Export tactic data
    function exportTacticData() {
        const tacticName = document.getElementById('modalTacticName').textContent;
        const table = document.getElementById('modalTechniquesList');
        const rows = table.querySelectorAll('tr');
        
        let csv = 'Technique ID,Name,Severity,API Call\n';
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 4) {
                const techniqueId = cells[0].textContent.replace(/`/g, '');
                const name = cells[1].textContent.replace(/\*/g, '');
                const severity = cells[2].textContent;
                const apiCall = cells[3].textContent.replace(/`/g, '');
                
                csv += `"${techniqueId}","${name}","${severity}","${apiCall}"\n`;
            }
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${tacticName.replace(/\s+/g, '_')}_techniques.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
</script>
{% endblock %}